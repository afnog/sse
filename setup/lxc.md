# VM setup using LXC

Install Ubuntu Desktop (not Server) 16.04 AMD64.

Create `/etc/network/iptables` with the following contents:

	# Generated by iptables-save v1.6.0 on Fri May 27 17:09:25 2016
	*filter
	:INPUT ACCEPT [3:152]
	:FORWARD ACCEPT [0:0]
	:OUTPUT ACCEPT [256:31110]
	-A INPUT -m state --state ESTABLISHED -j ACCEPT
	-A INPUT -i lo -p udp -m udp --dport 53 -m comment --comment "Allow local dnsmasq" -j ACCEPT
	-A INPUT -i lxcbr0 -p tcp -m tcp --dport 53 -j ACCEPT
	-A INPUT -i lxcbr0 -p udp -m udp --dport 53 -j ACCEPT
	-A INPUT -i lxcbr0 -p tcp -m tcp --dport 67 -j ACCEPT
	-A INPUT -i lxcbr0 -p udp -m udp --dport 67 -j ACCEPT
	-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
	-A INPUT -s 196.200.208.0/20 -p tcp -m tcp --dport 3142 -j ACCEPT -m comment --comment "apt-cacher-ng"
	-A INPUT -d 255.255.255.255/32 -m comment --comment "Drop multicast without logging" -j DROP
	-A INPUT -m limit --limit 5/min -j LOG --log-prefix "Rejected INPUT: "
	-A FORWARD -o lxcbr0 -j ACCEPT
	-A FORWARD -i lxcbr0 -j ACCEPT
	COMMIT
	# Completed on Fri May 27 17:09:25 2016

Add the following lines to `/etc/rc.local` before the line `exit 0`:

	echo cfq > /sys/block/sda/queue/scheduler
	setpci -s 0:1f.0 0xa4.w=0:1
	iptables-restore /etc/network/iptables

And execute `/etc/rc.local`.

Setup a local APT cache:

	sudo apt install apt-cacher-ng

Following https://help.ubuntu.com/lts/serverguide/lxc.html:

	sudo apt install lxc vlan

	mkdir -p ~/.config/lxc
	echo "lxc.id_map = u 0 100000 65536" > ~/.config/lxc/default.conf
	echo "lxc.id_map = g 0 100000 65536" >> ~/.config/lxc/default.conf
	echo "lxc.network.type = veth" >> ~/.config/lxc/default.conf
	# echo "lxc.network.link = lxcbr0" >> ~/.config/lxc/default.conf
	echo "lxc.network.link = br0" >> ~/.config/lxc/default.conf
	# echo "$USER veth lxcbr0 2" | sudo tee -a /etc/lxc/lxc-usernet
	echo "$USER veth br0 2" | sudo tee -a /etc/lxc/lxc-usernet

	# https://help.ubuntu.com/lts/serverguide/network-configuration.html#bridging
	sudo apt install bridge-utils

Edit `/etc/network/interfaces` and make it look like this, to enable bridging for LXC containers:

	auto lo
	iface lo inet loopback

	auto enp1s0f0
	iface enp1s0f0 inet static
		address 196.200.223.144
		netmask 255.255.255.0
		gateway 196.200.223.1

	auto br0
	iface br0 inet static
		# Please check the following values are appropriate for your network:
		address 196.200.219.2
		netmask 255.255.255.0
		bridge_ports enp1s0f0.219
		bridge_fd 0
		bridge_hello 2
		bridge_maxage 12
		bridge_stp off

	auto enp1s0f0.219
	iface enp1s0f0.219 inet static
		address 0.0.0.0
		vlan-raw-device enp1s0f0

Then bring the interface down and up again:

	sudo ifdown enp1s0f0
	sudo ifup br0

Check that you can access the Internet, and then reboot the box and check that it comes up OK.

	# lxc-create --template debian --name debian8
	lxc-create -t download -n debian8 -- --dist debian --release jessie --arch i386
	lxc-ls
	chmod a+x .local
	chmod a+x .local/share
	lxc-start --name debian8
	lxc-attach --name debian8

Now we can setup the guest:

	adduser afnog
	apt install nano sudo openssh-server vim ping
	usermod -G sudo afnog

You should now be able to SSH in as user `afnog` to complete the installation:

	sudo vi /etc/network/interfaces

Make it look like this:

	auto lo
	iface lo inet loopback

	auto eth0
	iface eth0 inet static
		# Please check the following values are appropriate for your network:
		address 196.200.219.100
		netmask 255.255.255.0
		gateway 196.200.219.1

Restart networking (on the guest) and reconnect using the new IP (196.200.219.100).

Copy an SSH key into the guest:

	scp ~/.ssh/id_rsa.pub afnog@196.200.219.100:.ssh/authorized_keys

Sudo edit `/etc/apt/apt.conf.d/01proxy` and add:

	Acquire::http::Proxy "http://196.200.219.2:3142";

Check that you can run `apt update` on the guest.


